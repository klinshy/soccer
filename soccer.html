/// <reference types="@workadventure/iframe-api-typings" />

<!DOCTYPE html>
<html lang="en">
    <head>
        <title>BWI WorkAdventure Soccer</title>
				<script src="https://play.workadventu.re/iframe_api.js"></script>
			</head>
			<body>
			</body>
		</html>
    </head>
    <body style="background-color:#00000000; margin:0px; padding:0px">
		<svg id="spielfeld" width="799" height="560" alt="Spielfeld - leider nur optisch" style="margin: 0px; padding: 0px"  xmlns="http://www.w3.org/2000/svg">
			<style>
				.goalCounter {
					font: bold 30px sans-serif;
					fill: black;
					text-anchor: middle; 
					alignment-baseline: central;
				}
			</style>
			<image x="100px" y="100px" id="ball" href="fussball.png" width="24px" height="24px" stroke="none"/>
			<image x="591px" y="20px" id="ball_reset" href="fussball.png" width="18px" height="18px" stroke="none"/>
			<circle id="playerPointer" cx="50" cy="50" r="0.5" style="fill:red" />
			<circle id="ballPointer" cx="50" cy="50" r="0.5" style="fill:blue" />
		</svg>
		<script>
		
let ball = document.getElementById('ball');
let playerPointer = document.getElementById('playerPointer');
let ballPointer = document.getElementById('ballPointer');
let ballReset = document.getElementById('ball_reset');
let svgElement = document.getElementById('spielfeld');

// helper to play Ball Games
async function startBallGame(ballGameDef ) {
	let myName = WA.player.name;
	let ballImpulse = 18.0;
	let ballSlowdown = 0.72;
	let ballMoveImpulse = 0.0;
	let ballMoveDirection = 0.0;
	let ballMoving = false;
	const ballHitOffsetX = 0.0; 
	const ballHitOffsetY = 0.0;
	const ballHitReductionX = 0.0; 
	const ballHitReductionY = 0.0;
	const millisBallDebounce = 500;
	const goalWaitTime = 2500;
	const ballWidth = 24.0;
	const ballHeight = 24.0;
	const field = await WA.room.website.get(ballGameDef.gameArea);
	const ballBounceBox = await WA.room.area.get(ballGameDef.ballArea);
	let goals = new Array(ballGameDef.goalAreas.length);
	let goalCounter = new Array(ballGameDef.goalAreas.length);
	goals.fill(0);
	for (const goal in goals) {
		const goalArea = await WA.room.area.get(ballGameDef.goalAreas[goal]);
		goalCounter[goal] = document.createElementNS('http://www.w3.org/2000/svg','text');
		goalCounter[goal].setAttributeNS(null, 'x', goalArea.x + (goalArea.width/2) - field.x);
		goalCounter[goal].setAttributeNS(null, 'y', goalArea.y + (goalArea.height/2) - field.y);
		goalCounter[goal].setAttributeNS(null, 'class','goalCounter');
		svgElement.appendChild(goalCounter[goal]);
		const tmpGoal = document.createElementNS('http://www.w3.org/2000/svg','rect');
	}
	showScore();

	function showScore() {
		for (const goal in goals) {
			goalCounter[goal].textContent = goals[goal];
		}
	}

	const viewPortXExtend = 32;
	let ballX = 100.0;
	let ballY = 100.0;
	let isGoal = false;
	let goalSince = 0;
	ballReset.addEventListener("click", function(event){
      // You can now call your desired function and pass the event and your argument
		console.info('BWI SoccerSkript: reset button');
		ballX = (ballBounceMinX+ballBounceMaxX)/2-ballCenterX;
		ballY = (ballBounceMinY+ballBounceMaxY)/2-ballCenterY;
		ballMoveImpulse = 0;
		isGoal = false;
		goals = new Array(ballGameDef.goalAreas.length);
		goals.fill(0);
		WA.state.saveVariable(ballGameDef.ballVariable, JSON.stringify({"x":ballX, "y":ballY, "impulse":0, "direction":ballMoveDirection, "controller":myName, "lastHit":Date.now(), "action":"none", "goalsIn":goals }));
	});

	const ballCenterX = ballHitOffsetX + (ballWidth - ballHitReductionX)/2;
	const ballCenterY = ballHitOffsetY + (ballHeight - ballHitReductionY)/2;
	const ballBounceMinX = ballBounceBox.x - field.x;
	const ballBounceMinY = ballBounceBox.y - field.y;
	const ballBounceMaxX = ballBounceMinX + ballBounceBox.width;
	const ballBounceMaxY = ballBounceMinY + ballBounceBox.height;
	let activeController = "";
	const area = WA.room.area.create({
		name: 'ballGameFocus',
		x: field.x,
		y: field.y,
		width: field.width,
		height: field.height,
	});	
	WA.room.area.onEnter("ballGameFocus").subscribe(() => {
		WA.camera.set(field.x + (field.width/2), field.y + (field.height/2), (field.width+2*viewPortXExtend), field.height, true, true, 1500);
	});
	
	WA.room.area.onLeave("ballGameFocus").subscribe(() => {
		WA.camera.followPlayer(true);
	});
	
	async function checkIfWithinBoundariesOfArea(x, y, areaName) {
		const areaOfInterest = await WA.room.area.get(areaName);
		if (x < areaOfInterest.x-field.x) return false;
		if (y < areaOfInterest.y-field.y) return false;
		if (x > (areaOfInterest.x-field.x + areaOfInterest.width)) return false;
		if (y > (areaOfInterest.y-field.y + areaOfInterest.height)) return false;
		return true;
	}
	
	async function checkCollision() {
		const playerPos = await WA.player.getPosition();
		const deltaX = (playerPos.x - field.x) - (ballX + ballCenterX);
		const deltaY = (playerPos.y - field.y) - (ballY + ballCenterY);
		const dist = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
		setMarkerPosition(ballX + ballCenterX, ballY + ballCenterY, playerPos.x - field.x, playerPos.y - field.y);
//		console.info('BWI SoccerSkript: checkCollision: ', playerPos, field, deltaX, deltaY, dist);
		if ((dist < 18) && (!isGoal)) {
			let lastMovement = JSON.parse(WA.state.loadVariable(ballGameDef.ballVariable));
			console.info('BWI SoccerSkript: checkCollision - lastMovement: ', lastMovement);
				// Play random kick sound
				const kickSounds = ["kick1.wav", "kick2.wav", "kick3.wav"];
					const randomSound = kickSounds[Math.floor(Math.random() * kickSounds.length)];
					const audio = new Audio(randomSound);
					audio.play();
			if ((lastMovement.lastHit+millisBallDebounce) < Date.now()) {
				ballMoveDirection = Math.atan2((playerPos.y - field.y) - (ballY + ballCenterY), (playerPos.x - field.x) - (ballX + ballCenterX)) - (Math.PI/2);
				console.info('BWI SoccerSkript: checkCollision - ballMoveDirection: ',ballMoveDirection);
				activeController = myName;
				WA.state.saveVariable(ballGameDef.ballVariable, JSON.stringify({"x":ballX, "y":ballY, "impulse":ballImpulse, "direction":ballMoveDirection, "controller":myName, "lastHit":Date.now(), "action":"kick", "goalsIn":goals }));
			}
		}
	}

	function setMarkerPosition(bx, by, px, py) {
		ballPointer.setAttribute("cx",bx);
		ballPointer.setAttribute("cy",by);
		playerPointer.setAttribute("cx",px);
		playerPointer.setAttribute("cy",py);
	}
	function setBallPosition() {
		ball.setAttribute("x",ballX);
		ball.setAttribute("y",ballY);
	}

	async function moveBall() {
		if (ballMoveImpulse>ballSlowdown) {
			ballMoving = true;
			setTimeout(moveBall, 50);
//			console.info('BWI SoccerSkript: moveBall ',ballMoveDirection,ballMoveImpulse,ballX, ballY);
			ballX += Math.sin(ballMoveDirection)*ballMoveImpulse;
			ballY -= Math.cos(ballMoveDirection)*ballMoveImpulse;
//			console.info('BWI SoccerSkript: moveBall nextPos should be ',ballMoveDirection,ballMoveImpulse,ballX, ballY);

			if (activeController == myName) {
				let goalIn = undefined;
				for (const goal in ballGameDef.goalAreas) {
					const checkGoal = await checkIfWithinBoundariesOfArea(ballX+ballCenterX, ballY+ballCenterY, ballGameDef.goalAreas[goal]);
//					console.info('BWI SoccerSkript: moveBall checkGoal goal:' + goal + ' = ' + checkGoal);
					if (checkGoal == true) goalIn = goal;
					
				}
				if (goalIn != undefined) {
					console.info('BWI SoccerSkript: goal detected - saveVariable after goal');
					isGoal = true;
					goalAt = Date.now();
					goals[goalIn] += 1;
					ballMoveImpulse = 0;
					const goalSounds = ["crowd.wav", "crowd2.wav", "crowd3.wav", "crowd4.wav", "crowd5.wav"];
					const randomGoalSound = goalSounds[Math.floor(Math.random() * goalSounds.length)];
					const goalAudio = new Audio(randomGoalSound);
					goalAudio.play();
					WA.state.saveVariable(ballGameDef.ballVariable, JSON.stringify({"x":ballX, "y":ballY, "impulse":0, "direction":ballMoveDirection, "controller":myName, "lastHit":Date.now(), "action":"goal", "goalsIn":goals  }));
				}
			}
			if (!isGoal) {
				if (ballX+ballCenterX<ballBounceMinX) {
					ballX += (ballBounceMinX-(ballX+ballCenterX));
					ballMoveDirection = -ballMoveDirection;
				}
				if (ballY+ballCenterY<ballBounceMinY) {
					ballY += (ballBounceMinY-(ballY+ballCenterY));
					ballMoveDirection = -(ballMoveDirection + Math.PI);
				}
				if (ballX+ballCenterX>ballBounceMaxX) {
					ballX -= ((ballX+ballCenterX)-ballBounceMaxX);
					ballMoveDirection = -ballMoveDirection;
				}
				if (ballY+ballCenterY>ballBounceMaxY) {
					ballY -= ((ballY+ballCenterX)-ballBounceMaxY);
					ballMoveDirection = -(ballMoveDirection + Math.PI);
				}
				ballMoveImpulse -= ballSlowdown;
			}
			setBallPosition();
			
		} else {
			ballMoving = false;
			if (activeController == myName) {
				if (!isGoal) {
					console.info('BWI SoccerSkript: saveVariable after kick is over');
					WA.state.saveVariable(ballGameDef.ballVariable, JSON.stringify({"x":ballX, "y":ballY, "impulse":0, "direction":ballMoveDirection, "controller":myName, "lastHit":Date.now(), "action":"none", "goalsIn":goals }));
				} else {
					if (goalAt + goalWaitTime < Date.now()) {
						console.info('BWI SoccerSkript: saveVariable for reset');
						ballX = (ballBounceMinX+ballBounceMaxX)/2-ballCenterX;
						ballY = (ballBounceMinY+ballBounceMaxY)/2-ballCenterY;
						ballMoveImpulse = 0;
						isGoal = false;
						WA.state.saveVariable(ballGameDef.ballVariable, JSON.stringify({"x":ballX, "y":ballY, "impulse":0, "direction":ballMoveDirection, "controller":myName, "lastHit":Date.now(), "action":"none", "goalsIn":goals }));
					} else {
						setTimeout(moveBall, 50);
					}
				}
			}
		}
	}

	async function checkVariable(value) {
		let newMovement = JSON.parse(value);
		activeController = newMovement.controller;
		ballX = newMovement.x;
		ballY = newMovement.y;
		ballMoveImpulse = newMovement.impulse;
		ballMoveDirection = newMovement.direction;
		goals = newMovement.goalsIn;
		isGoal = (newMovement.action=='goal');
		showScore();
		console.info('BWI SoccerSkript: checkVariable - read new values:',value);

		if (!ballMoving) {
			if (ballMoveImpulse!=0) {
				await moveBall();
			} else {
				setBallPosition();
			}
		}
	}

	WA.state.onVariableChange(ballGameDef.ballVariable).subscribe(checkVariable);

	await checkVariable(WA.state.loadVariable(ballGameDef.ballVariable));
	setInterval(checkCollision, 50);

	console.info("BWI SoccerSkript: startBallGame gesetzt.");
}

//WA.onInit().then(async () => {
//	await startBallGame({"ballVariable": "vBall", "ballControllerVariable":"vBallController", "gameArea":"webSoccerGame", "ballArea":"aFeld", "goalAreas":["aTorLinks","aTorRechts"]});
	await startBallGame({"ballVariable": "vBall", "gameArea":"webSoccerGame", "ballArea":"aFeld", "goalAreas":["aTorLinks","aTorRechts"]});
//});
            
        </script>
    </body>
</html>